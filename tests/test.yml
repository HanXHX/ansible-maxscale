---

- hosts: all
  vars:
    maxscale_log_notice: 1
    maxscale_log_info: 1
    maxscale_log_debug: 1
    maxscale_servers:
      - name: 'me'
        address: '127.0.0.1'
      - name: 'themaster'
        address: '192.168.201.12'
      - name: 'theslave'
        address: '192.168.201.13'
    maxscale_services:
      readme:
        router: 'readconnroute'
        servers: 'me'
        router_options: 'running'
        user: 'maxscale'
        passwd: '1a2b3c'
      writme:
        router: 'readwritesplit'
        servers: 'me'
        user: 'maxscale'
        passwd: '1a2b3c'
    maxscale_listeners:
      merwsock:
        service: 'readme Service'
        socket: '/tmp/maxscale_rw.sock'
      mereadtcp:
        service: 'writme Service'
        address: '0.0.0.0'
        port: 12345
    maxscale_monitors:
      me:
        module: 'mysqlmon'
        servers: 'me'
        user: 'maxscale'
        passwd: '1a2b3c'
  roles:
    - mariadb
    - ../../
  post_tasks:
    - block:
        - name: TEST ---- Check if maxscale is started
          shell: ps aux | grep -q ^maxscale
          register: ps
          failed_when: false
        - name: TEST ---- Start Maxscale (when init is not systemd)
          command: /usr/bin/maxscale --user=maxscale
          when: ps.rc == 1
        - name: TEST ---- Pause 1 sec
          pause: seconds=1
          when: ps.rc == 1
      when: ansible_service_mgr != 'systemd'
    - name: TEST ---- maxadmin
      command: maxadmin 'list listeners'
      changed_when: false
